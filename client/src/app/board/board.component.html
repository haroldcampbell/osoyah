<section class="board-shell">
  <header class="board-header">
    <div class="board-title" data-testid="board-title">Kanban</div>
    <p class="board-subtitle">Minimal board for focused flow.</p>
  </header>

  @if (loading) {
    <div class="board-state">Loading board...</div>
  }
  @if (error) {
    <div class="board-state error">{{ error }}</div>
  }

  @if (board && !loading) {
    <div class="board" data-testid="board">
    <div class="board-toolbar">
      <div class="board-name">{{ board.title }}</div>
      <div class="add-list">
        <input
          type="text"
          placeholder="New list title"
          [(ngModel)]="newListTitle"
          (keyup.enter)="addList()"
          data-testid="add-list-input"
        />
        <button type="button" (click)="addList()" data-testid="add-list-button">Add list</button>
      </div>
    </div>

    <div
      class="lists"
      cdkDropList
      cdkDropListOrientation="horizontal"
      [cdkDropListData]="board.lists"
      (cdkDropListDropped)="dropList($event)"
    >
      @for (list of board.lists; track trackByListId) {
        <article
          class="list"
          cdkDrag
          data-testid="list"
          [attr.data-list-id]="list.id"
          [attr.data-list-title]="list.title"
        >
          <header class="list-header" cdkDragHandle data-testid="list-handle">
            @if (editingListId !== list.id) {
              <div class="list-title" data-testid="list-title">
                {{ list.title }}
              </div>
            } @else {
              <input
                type="text"
                class="list-title-input"
                [(ngModel)]="editingListTitle"
                (keyup.enter)="saveListEdit(list)"
                data-testid="list-title-input"
              />
            }
            <div class="list-actions">
              @if (editingListId !== list.id) {
                <button type="button" (click)="startListEdit(list)" data-testid="edit-list">
                  Rename
                </button>
              } @else {
                <button type="button" (click)="saveListEdit(list)" data-testid="save-list">Save</button>
                <button type="button" (click)="cancelListEdit()" data-testid="cancel-list">
                  Cancel
                </button>
              }
              <button type="button" (click)="removeList(list)" data-testid="remove-list">Remove</button>
            </div>
          </header>

        <div
          class="cards"
          cdkDropList
          [id]="list.id"
          [cdkDropListConnectedTo]="cardDropListIds"
          [cdkDropListData]="list.cards"
          (cdkDropListDropped)="dropCard($event)"
          data-testid="card-dropzone"
          [attr.data-list-id]="list.id"
        >
          @for (card of list.cards; track trackByCardId) {
            <div class="card" cdkDrag data-testid="card" [attr.data-card-id]="card.id">
              @if (!isEditingCard(list, card)) {
                <div class="card-body">
                  <div class="card-title">{{ card.title }}</div>
                  @if (card.description) {
                    <p class="card-description">{{ card.description }}</p>
                  }
                  <div class="card-actions">
                    <button type="button" (click)="startCardEdit(list, card)" data-testid="edit-card">
                      Edit
                    </button>
                    <button type="button" (click)="removeCard(list, card)" data-testid="remove-card">
                      Delete
                    </button>
                  </div>
                </div>
              } @else {
                <div class="card-edit">
                  <input
                    type="text"
                    placeholder="Card title"
                    [(ngModel)]="editingCardTitle"
                    data-testid="card-title-input"
                  />
                  <textarea
                    rows="3"
                    placeholder="Description"
                    [(ngModel)]="editingCardDescription"
                    data-testid="card-description-input"
                  ></textarea>
                  <div class="card-actions">
                    <button type="button" (click)="saveCardEdit(list, card)" data-testid="save-card">
                      Save
                    </button>
                    <button type="button" (click)="cancelCardEdit()" data-testid="cancel-card">
                      Cancel
                    </button>
                  </div>
                </div>
              }
            </div>
          }

          @if (list.cards.length === 0) {
            <div class="empty-cards">No cards yet.</div>
          }
        </div>

        <div class="add-card">
          <input
            type="text"
            placeholder="Add a card"
            [(ngModel)]="newCardTitles[list.id]"
            (keyup.enter)="addCard(list)"
            data-testid="add-card-input"
            [attr.data-list-id]="list.id"
          />
          <button type="button" (click)="addCard(list)" data-testid="add-card-button">Add card</button>
        </div>
        </article>
      }

      @if (board.lists.length === 0) {
        <div class="empty-board">No lists yet. Add one to start.</div>
      }
    </div>
    </div>
  }
</section>
